<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orientaci√≥n para el Autodescubrimiento - Equipo UNAH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .step-content { display: none; }
        .step-content.active { display: block; }
        #reporte-final.visible-report, #reporte-general.visible-report {
            display: block !important;
            background: white;
            padding: 40px;
            min-height: 100vh;
        }
        #reporte-final, #reporte-general { display: none; }
        @media print {
            body { background: white !important; padding: 0 !important; }
            #app-container, #user-list-container, .no-print, #btn-volver-listado { display: none !important; }
            #reporte-final, #reporte-general { display: block !important; position: absolute; left:0; top:0; width:100%; margin:0; padding:0; visibility: visible !important; }
            #reporte-final *, #reporte-general * { visibility: visible !important; }
            .print-section { page-break-inside: avoid; border-bottom:1px solid #eee; padding:15px 0; }
            @page { size: portrait; margin: 1.5cm; }
        }
        .sesion-item { transition: all 0.2s; }
    </style>
</head>
<body class="p-2 md:p-6">

    <!-- LISTADO DE ESTUDIANTES -->
    <div id="user-list-container" class="max-w-5xl mx-auto">
        <div class="bg-white shadow-2xl rounded-3xl overflow-hidden border border-slate-200 p-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-2xl font-black uppercase text-indigo-900">Estudiantes registrados</h1>
                <div class="flex gap-4">
                    <button onclick="mostrarReporteGeneral()" class="bg-indigo-100 text-indigo-700 px-6 py-3 rounded-xl text-xs font-bold uppercase hover:bg-indigo-200 transition">Reporte general</button>
                    <button onclick="crearNuevoEstudiante()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl text-xs font-bold uppercase hover:bg-indigo-700 transition shadow">+ Nuevo estudiante</button>
                </div>
            </div>
            <div id="user-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Se llena con JS -->
            </div>
        </div>
    </div>

    <!-- FORMULARIO INDIVIDUAL -->
    <div class="max-w-5xl mx-auto no-print hidden" id="app-container">
        <div class="bg-white shadow-2xl rounded-3xl overflow-hidden border border-slate-200">
            <div class="bg-indigo-900 p-4 text-white flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <button onclick="volverAlListado()" class="bg-indigo-800 hover:bg-indigo-700 px-4 py-2 rounded-lg text-xs font-bold uppercase flex items-center gap-2">
                        ‚Üê Volver al listado
                    </button>
                    <div class="h-6 w-px bg-indigo-700"></div>
                    <div>
                        <h1 class="text-lg font-black tracking-tighter uppercase">Protocolo de Autodescubrimiento</h1>
                        <p class="text-indigo-300 text-[8px] font-bold uppercase">Estudiante: <span id="current-user-name-display"></span></p>
                    </div>
                </div>
                <div id="stepCounter" class="bg-indigo-800 px-4 py-2 rounded-full text-[10px] font-bold uppercase border border-indigo-700">
                    ETAPA 1/6
                </div>
            </div>

            <form id="mainForm" class="p-6 md:p-10" onsubmit="return false;">
                <!-- ETAPA 1: Identificaci√≥n -->
                <div id="step1" class="step-content active">
                    <div class="mb-8 border-b pb-4">
                        <h2 class="text-2xl font-black uppercase text-indigo-900">01. Datos del Estudiante</h2>
                        <p class="text-slate-500 text-sm italic">Informaci√≥n b√°sica para el proceso.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Nombre completo</label>
                            <input type="text" id="entrevistado" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 focus:border-indigo-600 outline-none transition" placeholder="Ej. Mar√≠a P√©rez">
                        </div>
                        <div class="space-y-4">
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Orientador responsable</label>
                            <input type="text" id="entrevistador" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 focus:border-indigo-600 outline-none transition" placeholder="Tu nombre">
                        </div>
                        <div class="space-y-4">
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Fecha de inicio</label>
                            <input type="date" id="fecha" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 focus:border-indigo-600 outline-none transition">
                        </div>
                        <div class="space-y-4">
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Edad</label>
                            <input type="number" id="edad" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 focus:border-indigo-600 outline-none transition" placeholder="18">
                        </div>
                    </div>
                </div>

                <!-- ETAPA 2: Entrevista inicial -->
                <div id="step2" class="step-content">
                    <div class="mb-8 border-b pb-4">
                        <h2 class="text-2xl font-black uppercase text-indigo-900">02. Entrevista de Diagn√≥stico</h2>
                        <p class="text-slate-500 text-sm">Registra las respuestas del estudiante a estas preguntas abiertas.</p>
                    </div>
                    <div class="space-y-6">
                        <div><label class="block text-xs font-bold text-indigo-800 mb-2">1. ¬øQu√© actividades te hacen perder la noci√≥n del tiempo y te generan satisfacci√≥n?</label><textarea id="preg1" rows="2" class="w-full p-3 border-2 border-slate-100 rounded-xl focus:border-indigo-600 outline-none"></textarea></div>
                        <div><label class="block text-xs font-bold text-indigo-800 mb-2">2. ¬øQu√© cr√≠ticas o expectativas has recibido de tu familia sobre tu futuro profesional?</label><textarea id="preg2" rows="2" class="w-full p-3 border-2 border-slate-100 rounded-xl focus:border-indigo-600 outline-none"></textarea></div>
                        <div><label class="block text-xs font-bold text-indigo-800 mb-2">3. Describe un momento en que te sentiste completamente realizado/a.</label><textarea id="preg3" rows="2" class="w-full p-3 border-2 border-slate-100 rounded-xl focus:border-indigo-600 outline-none"></textarea></div>
                        <div><label class="block text-xs font-bold text-indigo-800 mb-2">4. ¬øQu√© crees que espera la sociedad de ti en t√©rminos de carrera?</label><textarea id="preg4" rows="2" class="w-full p-3 border-2 border-slate-100 rounded-xl focus:border-indigo-600 outline-none"></textarea></div>
                        <div><label class="block text-xs font-bold text-indigo-800 mb-2">5. Si no hubiera limitaciones, ¬øqu√© te gustar√≠a hacer con tu vida?</label><textarea id="preg5" rows="2" class="w-full p-3 border-2 border-slate-100 rounded-xl focus:border-indigo-600 outline-none"></textarea></div>
                    </div>
                </div>

                <!-- ETAPA 3: Influencias -->
                <div id="step3" class="step-content">
                    <div class="mb-8 border-b pb-4">
                        <h2 class="text-2xl font-black uppercase text-indigo-900">03. Influencias Externas</h2>
                        <p class="text-slate-500 text-sm">Valora el grado de influencia y comenta.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-5 border-2 border-slate-100 rounded-3xl bg-white">
                            <div class="flex items-center gap-2 mb-4"><span class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold">Familia</span></div>
                            <input type="range" id="inf-fam" min="1" max="5" value="3" class="w-full accent-indigo-600">
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 mt-1"><span>Baja</span><span>Alta</span></div>
                            <textarea id="inf-fam-com" placeholder="Comentarios..." rows="2" class="w-full mt-4 p-3 text-sm border rounded-xl bg-slate-50"></textarea>
                        </div>
                        <div class="p-5 border-2 border-slate-100 rounded-3xl bg-white">
                            <div class="flex items-center gap-2 mb-4"><span class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold">Amigos / Grupo social</span></div>
                            <input type="range" id="inf-soc" min="1" max="5" value="3" class="w-full accent-indigo-600">
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 mt-1"><span>Baja</span><span>Alta</span></div>
                            <textarea id="inf-soc-com" placeholder="Comentarios..." rows="2" class="w-full mt-4 p-3 text-sm border rounded-xl bg-slate-50"></textarea>
                        </div>
                        <div class="p-5 border-2 border-slate-100 rounded-3xl bg-white">
                            <div class="flex items-center gap-2 mb-4"><span class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold">Educaci√≥n / Profesores</span></div>
                            <input type="range" id="inf-edu" min="1" max="5" value="3" class="w-full accent-indigo-600">
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 mt-1"><span>Baja</span><span>Alta</span></div>
                            <textarea id="inf-edu-com" placeholder="Comentarios..." rows="2" class="w-full mt-4 p-3 text-sm border rounded-xl bg-slate-50"></textarea>
                        </div>
                        <div class="p-5 border-2 border-slate-100 rounded-3xl bg-white">
                            <div class="flex items-center gap-2 mb-4"><span class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold">Claridad de prop√≥sito actual</span></div>
                            <input type="range" id="inf-claridad" min="1" max="5" value="3" class="w-full accent-indigo-600">
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 mt-1"><span>Difuso</span><span>Muy claro</span></div>
                        </div>
                    </div>
                </div>

                <!-- ETAPA 4: SMART -->
                <div id="step4" class="step-content">
                    <div class="mb-8 border-b pb-4">
                        <h2 class="text-2xl font-black uppercase text-indigo-900">04. Metas SMART para el Autodescubrimiento</h2>
                        <p class="text-slate-500 text-sm">Define objetivos espec√≠ficos, medibles, alcanzables, relevantes y con plazo.</p>
                    </div>
                    <div id="smartContainer" class="space-y-4"></div>
                    <button type="button" onclick="agregarMeta()" class="mt-4 bg-indigo-100 text-indigo-700 px-6 py-3 rounded-xl text-xs font-bold uppercase hover:bg-indigo-200 transition">+ A√±adir otra meta</button>
                </div>

                <!-- ETAPA 5: Sesiones -->
                <div id="step5" class="step-content">
                    <div class="mb-8 border-b pb-4">
                        <h2 class="text-2xl font-black uppercase text-indigo-900">05. Sesiones de Orientaci√≥n</h2>
                        <p class="text-slate-500 text-sm">Registra cada sesi√≥n con su objetivo y observaciones.</p>
                    </div>
                    <div id="sesionesContainer" class="space-y-4"></div>
                    <button type="button" onclick="agregarSesion()" class="mt-4 bg-indigo-100 text-indigo-700 px-6 py-3 rounded-xl text-xs font-bold uppercase hover:bg-indigo-200 transition">+ Registrar nueva sesi√≥n</button>
                </div>

                <!-- ETAPA 6: Generar informe -->
                <div id="step6" class="step-content text-center py-10">
                    <div class="max-w-md mx-auto bg-indigo-50 p-10 rounded-[3rem] border-2 border-dashed border-indigo-200">
                        <div class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <h2 class="text-2xl font-black uppercase text-indigo-900">Finalizar</h2>
                        <p class="text-slate-500 text-sm mt-2 mb-8">Revisa que toda la informaci√≥n est√© completa. Al generar el informe se bloquear√° la edici√≥n para mantener la integridad del diagn√≥stico.</p>
                        <button type="button" onclick="generarInformeIndividual()" class="w-full bg-indigo-600 text-white p-5 rounded-2xl font-black uppercase tracking-widest shadow-2xl hover:bg-indigo-700 transition transform hover:-translate-y-1">Generar informe final</button>
                    </div>
                </div>

                <!-- Navegaci√≥n -->
                <div class="mt-12 flex justify-between items-center border-t pt-8" id="nav-container">
                    <button type="button" id="prevBtn" class="px-6 py-3 text-xs font-black text-slate-400 uppercase tracking-widest hover:text-indigo-600 transition" onclick="changeStep(-1)">Atr√°s</button>
                    <button type="button" id="nextBtn" class="bg-indigo-600 text-white px-12 py-4 rounded-2xl text-xs font-black uppercase tracking-widest hover:bg-indigo-700 shadow-xl transition" onclick="changeStep(1)">Continuar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- REPORTE INDIVIDUAL -->
    <div id="reporte-final" class="max-w-5xl mx-auto shadow-none">
        <div class="no-print flex justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-lg border border-indigo-100">
            <div class="flex items-center gap-3">
                <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Informe individual - Vista previa</p>
            </div>
            <div class="flex gap-4">
                <button onclick="volverAlFormulario()" class="px-6 py-3 border-2 border-slate-200 rounded-xl text-[10px] font-black uppercase hover:bg-slate-50 transition">Editar / Volver</button>
                <button onclick="dispararImpresionIndividual()" class="px-8 py-3 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg hover:bg-indigo-700 transition">Imprimir / Guardar PDF</button>
            </div>
        </div>
        <div class="report-content bg-white p-12 border-4 border-slate-900 relative" id="reporte-impresion-individual">
            <!-- Cabecera UNAH -->
            <div style="display: flex; justify-content: space-between; border-bottom: 5px solid #000; padding-bottom: 20px; margin-bottom: 30px;">
                <div style="width: 80px;"><svg viewBox="0 0 100 100" fill="none"><circle cx="50" cy="50" r="45" stroke="black" stroke-width="2"/><path d="M30 40 L50 20 L70 40 M50 20 V80 M30 60 H70" stroke="black" stroke-width="5"/></svg></div>
                <div style="flex:1; text-align:center;"><h1 style="font-size:16pt; font-weight:900;">Universidad Nacional Aut√≥noma de Honduras</h1><h2 style="font-size:12pt;">Facultad de Humanidades y Artes</h2><h3 style="font-size:10pt;">Departamento de Pedagog√≠a</h3></div>
                <div style="width:80px; text-align:right; font-size:8pt;">OE-II<br>2026</div>
            </div>
            <div class="print-section"><h4 style="background:#000; color:#fff; padding:5px;">I. Identificaci√≥n</h4><table style="width:100%; margin-top:15px;" id="r-individual-ident"></table></div>
            <div class="print-section"><h4 style="background:#000; color:#fff; padding:5px;">II. S√≠ntesis de entrevista</h4><div id="r-individual-entrevista"></div></div>
            <div class="print-section"><h4 style="background:#000; color:#fff; padding:5px;">III. An√°lisis de influencias</h4><div style="display:flex; gap:30px;"><div style="width:250px;"><canvas id="r-individual-chart"></canvas></div><div style="flex:1; border:2px solid #000; padding:15px; text-align:center;"><span style="font-size:8pt;">√çNDICE DE AUTODETERMINACI√ìN</span><div id="r-individual-score" style="font-size:40pt;">0%</div><div id="r-individual-label" style="background:#000;color:#fff;"></div></div></div><div id="r-individual-influencias-detalle"></div></div>
            <div class="print-section"><h4 style="background:#000; color:#fff; padding:5px;">IV. Plan SMART</h4><table style="width:100%; border-collapse:collapse;" id="r-individual-smart"></table></div>
            <div class="print-section"><h4 style="background:#000; color:#fff; padding:5px;">V. Sesiones</h4><div id="r-individual-sesiones" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:15px;"></div></div>
            <div class="print-section"><h4 style="background:#000; color:#fff; padding:5px;">VI. Diagn√≥stico</h4><p id="r-individual-diag"></p><div id="r-individual-recomendaciones"></div></div>
            <div style="margin-top:100px; display:flex; justify-content:space-around;"><div style="width:200px; border-top:2px solid #000; padding-top:10px;">Firma del estudiante</div><div style="width:200px; border-top:2px solid #000; padding-top:10px;">Firma del orientador</div></div>
        </div>
    </div>

    <!-- REPORTE GENERAL -->
    <div id="reporte-general" class="max-w-5xl mx-auto shadow-none">
        <div class="no-print flex justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-lg border border-indigo-100">
            <div class="flex items-center gap-3">
                <span class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></span>
                <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Reporte General del Equipo</p>
            </div>
            <div class="flex gap-4">
                <button onclick="volverAlListadoDesdeGeneral()" class="px-6 py-3 border-2 border-slate-200 rounded-xl text-[10px] font-black uppercase hover:bg-slate-50 transition">Volver al listado</button>
                <button onclick="window.print()" class="px-8 py-3 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg hover:bg-indigo-700 transition">Imprimir reporte</button>
            </div>
        </div>
        <div class="report-content bg-white p-12 border-4 border-slate-900 relative" id="reporte-general-contenido">
            <div style="display: flex; justify-content: space-between; border-bottom: 5px solid #000; padding-bottom: 20px; margin-bottom: 30px;">
                <div style="width: 80px;"><svg viewBox="0 0 100 100" fill="none"><circle cx="50" cy="50" r="45" stroke="black" stroke-width="2"/><path d="M30 40 L50 20 L70 40 M50 20 V80 M30 60 H70" stroke="black" stroke-width="5"/></svg></div>
                <div style="flex:1; text-align:center;"><h1 style="font-size:16pt; font-weight:900;">Universidad Nacional Aut√≥noma de Honduras</h1><h2 style="font-size:12pt;">Facultad de Humanidades y Artes</h2><h3 style="font-size:10pt;">Departamento de Pedagog√≠a</h3></div>
                <div style="width:80px; text-align:right; font-size:8pt;">Reporte General<br>2026</div>
            </div>
            <h2 class="text-xl font-black uppercase mb-6">Estad√≠sticas del grupo</h2>
            <div id="general-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>
            <div class="mb-8">
                <h3 class="text-lg font-bold mb-2">Distribuci√≥n por nivel de autodeterminaci√≥n</h3>
                <canvas id="general-chart-pie" width="300" height="300" style="max-width:400px;"></canvas>
            </div>
            <div class="mb-8">
                <h3 class="text-lg font-bold mb-2">Promedio de influencias</h3>
                <canvas id="general-chart-bar" width="400" height="250"></canvas>
            </div>
            <div>
                <h3 class="text-lg font-bold mb-2">Listado de estudiantes e √≠ndices</h3>
                <table class="w-full border-collapse border border-slate-300">
                    <thead><tr class="bg-slate-100"><th class="border p-2">Nombre</th><th class="border p-2">√çndice de autodeterminaci√≥n</th><th class="border p-2">Nivel</th></tr></thead>
                    <tbody id="general-tabla"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // üî• CONFIGURACI√ìN DE FIREBASE (TUS CREDENCIALES YA INCLUIDAS) üî•
        const firebaseConfig = {
            apiKey: "AIzaSyBXJXjsftrIyQKjgFgY5yjFrRJToYFHd4U",
            authDomain: "orientacion-unah.firebaseapp.com",
            projectId: "orientacion-unah",
            storageBucket: "orientacion-unah.firebasestorage.app",
            messagingSenderId: "5638188709",
            appId: "1:5638188709:web:dfc0c1eb5aca2cb04b274c",
            measurementId: "G-J9MZ8VEZPH"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const COLLECTION_NAME = "estudiantes";

        // ---------- VARIABLES GLOBALES ----------
        let currentUserId = null;
        let currentUserData = null;
        let currentStep = 1;
        let chartIndividual = null;
        let chartPie = null, chartBar = null;
        let metas = [];
        let sesiones = [];

        // ---------- FUNCIONES DE FIRESTORE ----------
        async function cargarListadoDesdeFirestore() {
            const snapshot = await db.collection(COLLECTION_NAME).get();
            const usuarios = [];
            snapshot.forEach(doc => {
                usuarios.push({ id: doc.id, ...doc.data() });
            });
            renderizarListado(usuarios);
        }

        async function guardarEstudiante(id, data) {
            if (id) {
                await db.collection(COLLECTION_NAME).doc(id).update(data);
            } else {
                const docRef = await db.collection(COLLECTION_NAME).add(data);
                return docRef.id;
            }
        }

        async function eliminarEstudiante(id) {
            await db.collection(COLLECTION_NAME).doc(id).delete();
        }

        async function obtenerEstudiante(id) {
            const doc = await db.collection(COLLECTION_NAME).doc(id).get();
            return doc.exists ? { id: doc.id, ...doc.data() } : null;
        }

        // ---------- RENDERIZAR LISTADO ----------
        function renderizarListado(usuarios) {
            const container = document.getElementById('user-cards');
            if (!container) return;
            container.innerHTML = '';

            if (usuarios.length === 0) {
                container.innerHTML = '<p class="text-slate-500 col-span-3 text-center py-10">No hay estudiantes registrados. Crea uno nuevo.</p>';
                return;
            }

            usuarios.forEach(user => {
                const indice = calcularIndiceAutodeterminacion(user);
                const nivel = obtenerNivel(indice);
                const card = document.createElement('div');
                card.className = 'bg-indigo-50 p-6 rounded-2xl border-2 border-indigo-100 hover:shadow-xl transition';
                card.innerHTML = `
                    <h3 class="text-lg font-black text-indigo-900 mb-2">${user.entrevistado || 'Sin nombre'}</h3>
                    <p class="text-xs text-slate-600 mb-1">√çndice: ${indice}%</p>
                    <p class="text-xs font-bold ${nivel.clase} mb-4">${nivel.texto}</p>
                    <div class="flex justify-end gap-2">
                        <button onclick="seleccionarUsuario('${user.id}')" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold uppercase hover:bg-indigo-700 transition">Abrir ficha</button>
                        <button onclick="eliminarUsuario('${user.id}')" class="bg-red-500 text-white px-4 py-2 rounded-xl text-xs font-bold uppercase hover:bg-red-600 transition">Eliminar</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // ---------- CREAR NUEVO ESTUDIANTE ----------
        async function crearNuevoEstudiante() {
            const nombre = prompt('Nombre completo del estudiante:', 'Nuevo estudiante');
            if (!nombre) return;

            const nuevo = {
                entrevistado: nombre,
                entrevistador: '',
                fecha: '',
                edad: '',
                preg1: '', preg2: '', preg3: '', preg4: '', preg5: '',
                infFam: 3, infFamCom: '',
                infSoc: 3, infSocCom: '',
                infEdu: 3, infEduCom: '',
                infClaridad: 3,
                metas: [],
                sesiones: []
            };

            const id = await guardarEstudiante(null, nuevo);
            cargarListadoDesdeFirestore();
            seleccionarUsuario(id);
        }

        // ---------- SELECCIONAR USUARIO ----------
        async function seleccionarUsuario(userId) {
            const usuario = await obtenerEstudiante(userId);
            if (!usuario) return;
            currentUserId = userId;
            currentUserData = usuario;

            document.getElementById('current-user-name-display').innerText = usuario.entrevistado || 'Sin nombre';
            metas = usuario.metas || [];
            sesiones = usuario.sesiones || [];

            document.getElementById('entrevistado').value = usuario.entrevistado || '';
            document.getElementById('entrevistador').value = usuario.entrevistador || '';
            document.getElementById('fecha').value = usuario.fecha || '';
            document.getElementById('edad').value = usuario.edad || '';

            document.getElementById('preg1').value = usuario.preg1 || '';
            document.getElementById('preg2').value = usuario.preg2 || '';
            document.getElementById('preg3').value = usuario.preg3 || '';
            document.getElementById('preg4').value = usuario.preg4 || '';
            document.getElementById('preg5').value = usuario.preg5 || '';

            document.getElementById('inf-fam').value = usuario.infFam || 3;
            document.getElementById('inf-fam-com').value = usuario.infFamCom || '';
            document.getElementById('inf-soc').value = usuario.infSoc || 3;
            document.getElementById('inf-soc-com').value = usuario.infSocCom || '';
            document.getElementById('inf-edu').value = usuario.infEdu || 3;
            document.getElementById('inf-edu-com').value = usuario.infEduCom || '';
            document.getElementById('inf-claridad').value = usuario.infClaridad || 3;

            renderizarMetas();
            renderizarSesiones();

            document.getElementById('user-list-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('reporte-final').classList.remove('visible-report');

            currentStep = 1;
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById('step1').classList.add('active');
            document.getElementById('stepCounter').innerText = 'ETAPA 1/6';
            document.getElementById('nextBtn').style.display = 'inline-block';
        }

        // ---------- GUARDAR DATOS ACTUALES EN FIRESTORE ----------
        async function guardarDatosActuales() {
            if (!currentUserId) return;

            const datos = {
                entrevistado: document.getElementById('entrevistado').value,
                entrevistador: document.getElementById('entrevistador').value,
                fecha: document.getElementById('fecha').value,
                edad: document.getElementById('edad').value,
                preg1: document.getElementById('preg1').value,
                preg2: document.getElementById('preg2').value,
                preg3: document.getElementById('preg3').value,
                preg4: document.getElementById('preg4').value,
                preg5: document.getElementById('preg5').value,
                infFam: parseInt(document.getElementById('inf-fam').value) || 3,
                infFamCom: document.getElementById('inf-fam-com').value,
                infSoc: parseInt(document.getElementById('inf-soc').value) || 3,
                infSocCom: document.getElementById('inf-soc-com').value,
                infEdu: parseInt(document.getElementById('inf-edu').value) || 3,
                infEduCom: document.getElementById('inf-edu-com').value,
                infClaridad: parseInt(document.getElementById('inf-claridad').value) || 3,
                metas: metas,
                sesiones: sesiones
            };

            await guardarEstudiante(currentUserId, datos);
            currentUserData = datos;
        }

        // ---------- AUTO-GUARDADO ----------
        function configurarAutoGuardado() {
            const inputs = document.querySelectorAll('#mainForm input, #mainForm textarea, #mainForm select');
            inputs.forEach(input => {
                input.removeEventListener('input', guardarDatosActuales);
                input.addEventListener('input', guardarDatosActuales);
            });
        }

        // ---------- METAS ----------
        function renderizarMetas() {
            const container = document.getElementById('smartContainer');
            if (!container) return;
            container.innerHTML = '';
            metas.forEach((meta, index) => {
                const div = document.createElement('div');
                div.className = 'p-6 border-2 border-slate-100 rounded-3xl bg-white relative';
                div.innerHTML = `
                    <button type="button" onclick="eliminarMeta(${index})" class="absolute top-2 right-2 text-red-400 hover:text-red-600 text-xl">&times;</button>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="text-[10px] font-black text-indigo-400 uppercase">Objetivo</label>
                            <input type="text" value="${(meta.objetivo || '').replace(/"/g, '&quot;')}" onchange="actualizarMeta(${index}, 'objetivo', this.value)" class="w-full p-3 border rounded-xl bg-slate-50">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-indigo-400 uppercase">Plazo (fecha)</label>
                            <input type="date" value="${meta.plazo || ''}" onchange="actualizarMeta(${index}, 'plazo', this.value)" class="w-full p-3 border rounded-xl bg-slate-50">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-indigo-400 uppercase">Estrategia</label>
                            <input type="text" value="${meta.estrategia || ''}" onchange="actualizarMeta(${index}, 'estrategia', this.value)" class="w-full p-3 border rounded-xl bg-slate-50">
                        </div>
                        <div class="col-span-2">
                            <label class="text-[10px] font-black text-indigo-400 uppercase">Recursos necesarios</label>
                            <input type="text" value="${meta.recursos || ''}" onchange="actualizarMeta(${index}, 'recursos', this.value)" class="w-full p-3 border rounded-xl bg-slate-50">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function agregarMeta() {
            metas.push({ objetivo: '', plazo: '', estrategia: '', recursos: '' });
            renderizarMetas();
            guardarDatosActuales();
        }

        function actualizarMeta(index, campo, valor) {
            metas[index][campo] = valor;
            guardarDatosActuales();
        }

        function eliminarMeta(index) {
            metas.splice(index, 1);
            renderizarMetas();
            guardarDatosActuales();
        }

        // ---------- SESIONES ----------
        function renderizarSesiones() {
            const container = document.getElementById('sesionesContainer');
            if (!container) return;
            container.innerHTML = '';
            sesiones.forEach((sesion, index) => {
                const div = document.createElement('div');
                div.className = 'p-5 border-2 border-slate-100 rounded-3xl bg-white relative sesion-item';
                div.innerHTML = `
                    <button type="button" onclick="eliminarSesion(${index})" class="absolute top-2 right-2 text-red-400 hover:text-red-600 text-xl">&times;</button>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="text-[10px] font-black text-indigo-400 uppercase">Fecha</label>
                            <input type="date" value="${sesion.fecha || ''}" onchange="actualizarSesion(${index}, 'fecha', this.value)" class="w-full p-3 border rounded-xl bg-slate-50">
                        </div>
                        <div class="md:col-span-2">
                            <label class="text-[10px] font-black text-indigo-400 uppercase">Objetivo de la sesi√≥n</label>
                            <input type="text" value="${sesion.objetivo || ''}" onchange="actualizarSesion(${index}, 'objetivo', this.value)" class="w-full p-3 border rounded-xl bg-slate-50">
                        </div>
                        <div class="md:col-span-3">
                            <label class="text-[10px] font-black text-indigo-400 uppercase">Observaciones / acuerdos</label>
                            <textarea rows="2" onchange="actualizarSesion(${index}, 'observaciones', this.value)" class="w-full p-3 border rounded-xl bg-slate-50">${sesion.observaciones || ''}</textarea>
                        </div>
                        <div class="md:col-span-3 flex items-center gap-2">
                            <input type="checkbox" ${sesion.entrevista ? 'checked' : ''} onchange="actualizarSesion(${index}, 'entrevista', this.checked)" class="w-4 h-4 accent-indigo-600">
                            <span class="text-xs">En esta sesi√≥n se aplic√≥ la entrevista de autodescubrimiento</span>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function agregarSesion() {
            sesiones.push({ fecha: '', objetivo: '', observaciones: '', entrevista: false });
            renderizarSesiones();
            guardarDatosActuales();
        }

        function actualizarSesion(index, campo, valor) {
            sesiones[index][campo] = valor;
            guardarDatosActuales();
        }

        function eliminarSesion(index) {
            sesiones.splice(index, 1);
            renderizarSesiones();
            guardarDatosActuales();
        }

        // ---------- NAVEGACI√ìN ----------
        function changeStep(n) {
            if (currentStep + n < 1 || currentStep + n > 6) return;
            currentStep += n;
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById('stepCounter').innerText = `ETAPA ${currentStep}/6`;
            const nextBtn = document.getElementById('nextBtn');
            if (currentStep === 6) {
                nextBtn.style.display = 'none';
            } else {
                nextBtn.style.display = 'inline-block';
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
            guardarDatosActuales();
        }

        // ---------- VOLVER AL LISTADO ----------
        async function volverAlListado() {
            await guardarDatosActuales();
            currentUserId = null;
            currentUserData = null;
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('user-list-container').classList.remove('hidden');
            document.getElementById('reporte-final').classList.remove('visible-report');
            cargarListadoDesdeFirestore();
        }

        // ---------- ELIMINAR USUARIO ----------
        async function eliminarUsuario(userId) {
            if (confirm('¬øEst√°s seguro de eliminar este estudiante? Se perder√°n todos sus datos.')) {
                await eliminarEstudiante(userId);
                cargarListadoDesdeFirestore();
            }
        }

        // ---------- FUNCIONES DE C√ÅLCULO ----------
        function calcularIndiceAutodeterminacion(d) {
            const infFam = d.infFam || 3;
            const infSoc = d.infSoc || 3;
            const infEdu = d.infEdu || 3;
            const claridad = d.infClaridad || 3;
            const pesoFam = (6 - infFam) * 2;
            const pesoSoc = (6 - infSoc) * 2;
            const pesoEdu = (6 - infEdu) * 2;
            const pesoClar = claridad * 4;
            let score = Math.round(((pesoFam + pesoSoc + pesoEdu + pesoClar) / 44) * 100);
            return Math.min(100, Math.max(0, score));
        }

        function obtenerNivel(score) {
            if (score >= 75) return { texto: 'ALTA AUTODETERMINACI√ìN', clase: 'text-green-600', diagnostico: 'El estudiante muestra una clara percepci√≥n de su prop√≥sito y baja interferencia de influencias externas.', recomendacion: 'Potenciar la autonom√≠a mediante proyectos concretos.' };
            if (score >= 50) return { texto: 'AUTODETERMINACI√ìN MODERADA', clase: 'text-yellow-600', diagnostico: 'Existe claridad pero las influencias externas generan dudas.', recomendacion: 'Trabajar en diferenciaci√≥n entre deseos propios y ajenos.' };
            return { texto: 'BAJA AUTODETERMINACI√ìN', clase: 'text-red-600', diagnostico: 'Predominan influencias externas y baja claridad.', recomendacion: 'Priorizar autoconocimiento y an√°lisis de creencias limitantes.' };
        }

        // ---------- GENERAR INFORME INDIVIDUAL ----------
        async function generarInformeIndividual() {
            await guardarDatosActuales();
            if (!currentUserData) return;

            const d = currentUserData;

            document.getElementById('r-individual-ident').innerHTML = `
                <tr><td><strong>Estudiante:</strong></td><td>${d.entrevistado || '---'}</td><td><strong>Edad:</strong></td><td>${d.edad || '---'}</td></tr>
                <tr><td><strong>Orientador:</strong></td><td colspan="3">${d.entrevistador || '---'}</td></tr>
                <tr><td><strong>Fecha inicio:</strong></td><td colspan="3">${d.fecha || '---'}</td></tr>
            `;

            const preguntas = [d.preg1, d.preg2, d.preg3, d.preg4, d.preg5];
            let entrevistaHTML = '';
            if (preguntas.some(p => p)) {
                entrevistaHTML = '<ul style="list-style:disc; padding-left:20px;">' + 
                    preguntas.map((p,i) => p ? `<li><strong>Pregunta ${i+1}:</strong> ${p}</li>` : '').join('') + '</ul>';
            } else {
                entrevistaHTML = '<p>No se registraron respuestas.</p>';
            }
            document.getElementById('r-individual-entrevista').innerHTML = entrevistaHTML;

            const valores = [d.infFam, d.infSoc, d.infEdu, d.infClaridad];
            const ctx = document.getElementById('r-individual-chart').getContext('2d');
            if (chartIndividual) chartIndividual.destroy();
            chartIndividual = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Influencia familiar', 'Influencia social', 'Influencia educativa', 'Claridad'],
                    datasets: [{
                        data: valores,
                        backgroundColor: 'rgba(0,0,0,0.05)',
                        borderColor: '#000',
                        borderWidth: 2,
                        pointBackgroundColor: '#000',
                        pointRadius: 4
                    }]
                },
                options: { scales: { r: { min: 1, max: 5, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
            });

            const indice = calcularIndiceAutodeterminacion(d);
            document.getElementById('r-individual-score').innerText = indice + '%';
            const nivel = obtenerNivel(indice);
            document.getElementById('r-individual-label').innerText = nivel.texto;
            document.getElementById('r-individual-diag').innerText = nivel.diagnostico;
            document.getElementById('r-individual-recomendaciones').innerText = nivel.recomendacion;

            let detalle = '';
            if (d.infFamCom) detalle += `<p><strong>Familia:</strong> ${d.infFamCom}</p>`;
            if (d.infSocCom) detalle += `<p><strong>Amigos:</strong> ${d.infSocCom}</p>`;
            if (d.infEduCom) detalle += `<p><strong>Educaci√≥n:</strong> ${d.infEduCom}</p>`;
            document.getElementById('r-individual-influencias-detalle').innerHTML = detalle || '<p>Sin comentarios.</p>';

            let smartHTML = '';
            (d.metas || []).forEach(m => {
                if (m.objetivo) {
                    smartHTML += `<tr><td style="border:1px solid #000; padding:8px;">${m.objetivo}</td><td style="border:1px solid #000; padding:8px;">${m.plazo || '‚Äî'}</td><td style="border:1px solid #000; padding:8px;">${m.estrategia || '‚Äî'}</td><td style="border:1px solid #000; padding:8px;">${m.recursos || '‚Äî'}</td></tr>`;
                }
            });
            if (!smartHTML) smartHTML = '<tr><td colspan="4" style="text-align:center;">No hay metas SMART.</td></tr>';
            document.getElementById('r-individual-smart').innerHTML = smartHTML;

            let sesionesHTML = '';
            (d.sesiones || []).forEach((s, idx) => {
                sesionesHTML += `
                    <div style="border:1px solid #000; padding:10px; border-radius:8px;">
                        <strong>Sesi√≥n ${idx+1}</strong> ${s.fecha ? ' - ' + s.fecha : ''}<br>
                        <em>Objetivo:</em> ${s.objetivo || 'No especificado'}<br>
                        <em>Observaciones:</em> ${s.observaciones || '‚Äî'}<br>
                        ${s.entrevista ? '<span style="background:#000; color:#fff; padding:2px 5px;">Entrevista aplicada</span>' : ''}
                    </div>
                `;
            });
            if (!sesionesHTML) sesionesHTML = '<p>No hay sesiones registradas.</p>';
            document.getElementById('r-individual-sesiones').innerHTML = sesionesHTML;

            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('reporte-final').classList.add('visible-report');
        }

        function volverAlFormulario() {
            document.getElementById('reporte-final').classList.remove('visible-report');
            document.getElementById('app-container').classList.remove('hidden');
        }

        function dispararImpresionIndividual() {
            window.print();
        }

        // ---------- REPORTE GENERAL ----------
        async function mostrarReporteGeneral() {
            document.getElementById('user-list-container').classList.add('hidden');
            document.getElementById('reporte-general').classList.add('visible-report');
            await renderizarReporteGeneral();
        }

        async function renderizarReporteGeneral() {
            const snapshot = await db.collection(COLLECTION_NAME).get();
            const usuarios = [];
            snapshot.forEach(doc => usuarios.push({ id: doc.id, ...doc.data() }));

            if (usuarios.length === 0) {
                document.getElementById('general-stats').innerHTML = '<p class="col-span-4 text-center">No hay estudiantes registrados.</p>';
                return;
            }

            const total = usuarios.length;
            let sumIndice = 0, sumFam = 0, sumSoc = 0, sumEdu = 0, sumClar = 0;
            const niveles = { alta: 0, moderada: 0, baja: 0 };

            usuarios.forEach(u => {
                const indice = calcularIndiceAutodeterminacion(u);
                sumIndice += indice;
                sumFam += u.infFam || 3;
                sumSoc += u.infSoc || 3;
                sumEdu += u.infEdu || 3;
                sumClar += u.infClaridad || 3;
                if (indice >= 75) niveles.alta++;
                else if (indice >= 50) niveles.moderada++;
                else niveles.baja++;
            });

            const promIndice = Math.round(sumIndice / total);
            const promFam = (sumFam / total).toFixed(1);
            const promSoc = (sumSoc / total).toFixed(1);
            const promEdu = (sumEdu / total).toFixed(1);
            const promClar = (sumClar / total).toFixed(1);

            document.getElementById('general-stats').innerHTML = `
                <div class="bg-indigo-50 p-4 rounded-xl text-center"><span class="text-3xl font-black">${total}</span><br>Estudiantes</div>
                <div class="bg-indigo-50 p-4 rounded-xl text-center"><span class="text-3xl font-black">${promIndice}%</span><br>√çndice promedio</div>
                <div class="bg-indigo-50 p-4 rounded-xl text-center"><span class="text-3xl font-black">${promClar}</span><br>Claridad promedio</div>
                <div class="bg-indigo-50 p-4 rounded-xl text-center"><span class="text-3xl font-black">${niveles.alta}</span><br>Alta autodeterminaci√≥n</div>
            `;

            const ctxPie = document.getElementById('general-chart-pie').getContext('2d');
            if (chartPie) chartPie.destroy();
            chartPie = new Chart(ctxPie, {
                type: 'pie',
                data: {
                    labels: ['Alta', 'Moderada', 'Baja'],
                    datasets: [{
                        data: [niveles.alta, niveles.moderada, niveles.baja],
                        backgroundColor: ['#22c55e', '#eab308', '#ef4444']
                    }]
                }
            });

            const ctxBar = document.getElementById('general-chart-bar').getContext('2d');
            if (chartBar) chartBar.destroy();
            chartBar = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: ['Influencia familiar', 'Influencia social', 'Influencia educativa', 'Claridad'],
                    datasets: [{
                        data: [promFam, promSoc, promEdu, promClar],
                        backgroundColor: '#4f46e5'
                    }]
                },
                options: { scales: { y: { min: 1, max: 5, stepSize: 1 } }, plugins: { legend: { display: false } } }
            });

            let filas = '';
            usuarios.forEach(u => {
                const indice = calcularIndiceAutodeterminacion(u);
                const nivel = obtenerNivel(indice).texto;
                filas += `<tr><td class="border p-2">${u.entrevistado || 'Sin nombre'}</td><td class="border p-2">${indice}%</td><td class="border p-2">${nivel}</td></tr>`;
            });
            document.getElementById('general-tabla').innerHTML = filas;
        }

        function volverAlListadoDesdeGeneral() {
            document.getElementById('reporte-general').classList.remove('visible-report');
            document.getElementById('user-list-container').classList.remove('hidden');
            cargarListadoDesdeFirestore();
        }

        // ---------- INICIALIZACI√ìN ----------
        document.addEventListener('DOMContentLoaded', () => {
            cargarListadoDesdeFirestore();
            configurarAutoGuardado();
        });

        // Exponer funciones globalmente
        window.crearNuevoEstudiante = crearNuevoEstudiante;
        window.seleccionarUsuario = seleccionarUsuario;
        window.eliminarUsuario = eliminarUsuario;
        window.volverAlListado = volverAlListado;
        window.changeStep = changeStep;
        window.agregarMeta = agregarMeta;
        window.actualizarMeta = actualizarMeta;
        window.eliminarMeta = eliminarMeta;
        window.agregarSesion = agregarSesion;
        window.actualizarSesion = actualizarSesion;
        window.eliminarSesion = eliminarSesion;
        window.generarInformeIndividual = generarInformeIndividual;
        window.volverAlFormulario = volverAlFormulario;
        window.dispararImpresionIndividual = dispararImpresionIndividual;
        window.mostrarReporteGeneral = mostrarReporteGeneral;
        window.volverAlListadoDesdeGeneral = volverAlListadoDesdeGeneral;
    </script>
</body>
    </html>
